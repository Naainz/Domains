---
import Layout from '../layouts/Layout.astro';
---

<Layout>
  <div class="container mx-auto mt-10">
    <h1 class="text-4xl font-bold mb-6 text-center">Check Domain Availability</h1>
    <div class="flex flex-col items-center">
      <div class="flex justify-center">
        <input 
          type="text" 
          placeholder="Enter domain name" 
          class="w-80 px-4 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
          id="domain-input"
        />
        <button 
          class="ml-4 px-4 py-2 bg-blue-500 text-white rounded-md hover:bg-blue-600 transition" 
          id="check-button"
        >
          Check
        </button>
      </div>
      <p class="mt-2 text-sm text-blue-500 cursor-pointer" id="expand-search-options">...or search differently</p>
      <div id="search-options" class="hidden mt-4">
        <div class="flex flex-col">
          <div>
            <label class="block text-sm font-medium text-gray-700">Search by Nameservers</label>
            <input 
              type="text" 
              placeholder="Enter nameserver (at least one required)" 
              class="w-80 px-4 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 mt-2"
              id="nameserver-input"
            />
          </div>
          <div class="mt-4">
            <label class="block text-sm font-medium text-gray-700">Search by Registrar Name</label>
            <input 
              type="text" 
              placeholder="Enter registrar name" 
              class="w-80 px-4 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 mt-2"
              id="registrar-input"
            />
          </div>
        </div>
        <button 
          class="mt-4 px-4 py-2 bg-green-500 text-white rounded-md hover:bg-green-600 transition"
          id="search-alternative-button"
        >
          Search
        </button>
      </div>
    </div>
    <div id="result-container" class="mt-6 text-center"></div>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      let domain = '';
      let availability = null;
      let whoisData = '';
      const validTLDs = [
        'com', 'net', 'org', 'edu', 'gov', 'co', 'io', 'biz', 'info', 'me', 'us', 'uk', 'ca', 'de', 'jp', 'fr',
        'au', 'eu', 'cn', 'in', 'br', 'ru', 'za', 'nz'
      ];

      const domainInput = document.getElementById('domain-input') as HTMLInputElement;
      const checkButton = document.getElementById('check-button');
      const expandSearchOptions = document.getElementById('expand-search-options');
      const searchOptions = document.getElementById('search-options');
      const nameserverInput = document.getElementById('nameserver-input') as HTMLInputElement;
      const registrarInput = document.getElementById('registrar-input') as HTMLInputElement;
      const searchAlternativeButton = document.getElementById('search-alternative-button');
      const resultContainer = document.getElementById('result-container');

      expandSearchOptions.addEventListener('click', () => {
        searchOptions.classList.toggle('hidden');
      });

      const isValidTLD = (domain) => {
        const parts = domain.split('.');
        if (parts.length < 2) return false;
        const tld = parts[parts.length - 1].toLowerCase();
        return validTLDs.includes(tld);
      };

      const showLoading = () => {
        resultContainer.innerHTML = `
          <div class="flex justify-center items-center space-x-2">
            <div class="loader ease-linear rounded-full border-4 border-t-4 border-gray-200 h-8 w-8"></div>
            <p class="text-blue-500">I'm searching for the domain name "${domain}"'s availability, please wait...</p>
          </div>
        `;
      };

      const displayResults = (results) => {
        resultContainer.innerHTML = results.map((result, index) => {
          const { domainName, registrarName, additionalInfo } = result;
          const hiddenInfo = additionalInfo ? `<p class="text-sm text-gray-500">${additionalInfo}</p>` : '';
          return `
            <div class="cursor-pointer p-4 mb-4 border rounded-md shadow-sm text-left hover:bg-gray-100" id="result-card-${index}">
              <h2 class="font-bold">${domainName}</h2>
              <p class="font-medium">${registrarName}</p>
              ${hiddenInfo}
              <button class="mt-2 text-blue-500 text-sm" onclick="fetchWhoisData('${domainName}', ${index})">Show WHOIS Data</button>
              <button class="mt-2 ml-4 text-blue-500 text-sm" onclick="fetchDnsData('${domainName}', ${index})">DNS</button>
              <div id="whois-data-${index}" class="hidden mt-2 bg-gray-800 text-white p-2 rounded-md"><pre></pre></div>
              <div id="dns-data-${index}" class="hidden mt-2 bg-gray-800 text-white p-2 rounded-md"><pre></pre></div>
            </div>
          `;
        }).join('');
      };

      const fetchWhoisData = async (domainName, index) => {
        const whoisDataDiv = document.getElementById(`whois-data-${index}`).querySelector('pre');
        if (whoisDataDiv.parentElement.classList.contains('hidden')) {
          whoisDataDiv.parentElement.classList.remove('hidden');
          try {
            const response = await fetch(`/api/check-domain.json?domain=${domainName}`);
            const result = await response.json();
            whoisDataDiv.textContent = result.whoisData || 'No WHOIS data available.';
          } catch (error) {
            whoisDataDiv.textContent = 'Error retrieving WHOIS data.';
          }
        } else {
          whoisDataDiv.parentElement.classList.add('hidden');
        }
      };

      const fetchDnsData = async (domainName, index) => {
        const dnsDataDiv = document.getElementById(`dns-data-${index}`).querySelector('pre');
        if (dnsDataDiv.parentElement.classList.contains('hidden')) {
          dnsDataDiv.parentElement.classList.remove('hidden');
          try {
            const response = await fetch(`/api/dns.json?domain=${domainName}`);
            const result = await response.json();
            dnsDataDiv.textContent = result.dnsData || 'No DNS records available.';
          } catch (error) {
            dnsDataDiv.textContent = 'Error retrieving DNS data.';
          }
        } else {
          dnsDataDiv.parentElement.classList.add('hidden');
        }
      };

      window.fetchWhoisData = fetchWhoisData;
      window.fetchDnsData = fetchDnsData;

      domainInput.addEventListener('input', (e) => {
        const target = e.target as HTMLInputElement;
        domain = target.value;
      });

      checkButton.addEventListener('click', async () => {
        if (domain.includes(' ')) {
          resultContainer.innerHTML = '<p class="text-red-500">Invalid entry: domain name cannot contain spaces.</p>';
          return;
        }

        if (!isValidTLD(domain)) {
          resultContainer.innerHTML = '<p class="text-red-500">Invalid entry: domain must have a valid TLD.</p>';
          return;
        }

        if (domain) {
          showLoading();
          try {
            const response = await fetch(`/api/check-domain.json?domain=${domain}`);
            const result = await response.json();
            availability = result.available ? 'Available' : 'Registered';
            whoisData = result.whoisData || '';

            resultContainer.innerHTML = `
              <div class="cursor-pointer p-4 mb-4 border rounded-md shadow-sm text-left hover:bg-gray-100">
                <h2 class="font-bold">${domain}</h2>
                <p class="font-medium">${availability}</p>
                <button class="mt-2 text-blue-500 text-sm" onclick="fetchWhoisData('${domain}', 0)">Show WHOIS Data</button>
                <button class="mt-2 ml-4 text-blue-500 text-sm" onclick="fetchDnsData('${domain}', 0)">DNS</button>
                <div id="whois-data-0" class="hidden mt-2 bg-gray-800 text-white p-2 rounded-md"><pre>${whoisData}</pre></div>
                <div id="dns-data-0" class="hidden mt-2 bg-gray-800 text-white p-2 rounded-md"><pre></pre></div>
              </div>
            `;
          } catch (error) {
            console.error('Error checking domain:', error);
            resultContainer.innerHTML = `<p class="text-red-500">Error checking domain "${domain}".</p>`;
          }
        }
      });

      searchAlternativeButton.addEventListener('click', async () => {
        const nameserver = nameserverInput.value.trim();
        const registrar = registrarInput.value.trim();

        if (!nameserver && !registrar) {
          resultContainer.innerHTML = '<p class="text-red-500">Please provide a nameserver or registrar name to search.</p>';
          return;
        }

        showLoading();

        const simulatedResults = [];
        if (simulatedResults.length > 99) {
          resultContainer.innerHTML = '<p class="text-blue-500">99+ (HIDDEN)</p>';
        } else {
          displayResults(simulatedResults);
        }
      });
    });
  </script>

  <style>
    .loader {
      border-top-color: #3498db;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      0% {
        transform: rotate(0deg);
      }
      100% {
        transform: rotate(360deg);
      }
    }
  </style>
</Layout>
